<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="{{ url_for('static', filename='image/favicon.ico') }}" type="image/x-icon" />
    <title>Study Planner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body>
<div class="container">
    {% if session.username %}
        <div class="top-right-menu">
            <a href="{{ url_for('logout') }}" class="logout-btn">Log Out</a>
        </div>
    {% endif %}

    <h1>Study Planner</h1>

    <form id="planForm" action="{{ url_for('loading') }}" method="get" onsubmit="return prepareFormSubmission()">
        <input
                type="hidden"
                id="timetable_slots"
                name="timetable_slots"
                value="{{ timetable_slots|default('')|tojson|safe }}" />
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <button
                    type="button"
                    class="add-timetable-btn"
                    onclick="openModal()"
                    style="width: calc(50% - 5px);"> Load Timetable (Everytime)
            </button>
            <button
                    type="button"
                    id="loadJsonBtn" class="add-timetable-btn"
                    style="width: calc(50% - 5px); background-color: #A9A9A9;"> Load Saved Timetable
            </button>
        </div>

        <hr />

        <div id="subjects">
        </div>

        <button type="submit" class="submit-btn">
            Calculate Study Time
        </button>
    </form>

    {% if not session.username %}
        <div class="back-to-main" style="text-align: center; margin-top: 20px;">
            <a href="{{ url_for('main') }}">← Back to Main</a>
        </div>
    {% endif %}
</div>

<div class="overlay" id="overlay"></div>
<div class="modal" id="modal">
    <button class="close-btn" onclick="closeModal()">×</button>
    <h2>Load Timetable</h2>
    <form id="timetableForm">
        <div class="field-group">
            <label for="new_url">Everytime URL or ID:</label>
            <input
                    type="text"
                    id="new_url"
                    name="new_url"
                    placeholder="https://everytime.kr/@ABCDEFG1234"
                    required />
        </div>
        <button
                type="button"
                class="add-timetable-btn" onclick="submitTimetableUrl()">
            Save Timetable
        </button>
    </form>
</div>

<script id="initial_subjects_data_script_tag" type="application/json">
    {{ initial_subjects_data|default('[]')|tojson|safe }}
</script>

<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<script>
    function prepareFormSubmission() {
        // 기존 index.js에서 실행되는 로직을 복제
        const subjectItems = document.querySelectorAll('.subject-item');
        const subjectsArr = [];
        
        subjectItems.forEach(item => {
            const nameInput = item.querySelector('input[name="name"]');
            const weightInput = item.querySelector('input[name="weight"]');
            const majorCheckbox = item.querySelector('input[name="major"]');

            const name = nameInput ? nameInput.value.trim() : "";
            const weight = weightInput ? weightInput.value : "50"; // default if somehow missing
            const major = majorCheckbox ? majorCheckbox.checked : false; // default if somehow missing

            if (name) {
                subjectsArr.push({ name, weight: Number(weight), major });
            }
        });
        
        // 과목 JSON 데이터를 URL 파라미터로 전달
        if (subjectsArr.length > 0) {
            const timetableSlotsData = document.getElementById('timetable_slots').value;
            const subjectsJsonData = JSON.stringify(subjectsArr);
            
            // URL 파라미터로 데이터 전달
            window.location.href = `{{ url_for('loading') }}?timetable_data=${encodeURIComponent(timetableSlotsData)}&subjects_data=${encodeURIComponent(subjectsJsonData)}`;
            return false; // 폼 제출 방지
        }
        
        alert('최소 하나 이상의 과목을 입력해주세요.');
        return false; // 폼 제출 방지
    }
</script>
</body>
</html>