<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Study Planner</title>
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
<div class="container">
    {% if session.username %}
    <div class="top-right-menu">
        <a href="/logout" class="logout-btn">Log Out</a>
    </div>
    {% endif %}

    <h1>Study Planner</h1>
    <form action="/plan" method="post">
        <div>
            <label for="total_hours">Total Study Time (hours):</label>
            <input type="number" id="total_hours" name="total_hours" step="0.1" required>
        </div>
        <button type="button" class="add-timetable-btn add-new-timetable-btn" onclick="openModal()">Load Timetable</button>
        <hr>
        <div id="subjects">
        </div>
        <button type="submit">Calculate Study Time</button>
    </form>

    {% if not session.username %}
    <div style="text-align: center; margin-top: 20px;">
        <a href="/" style="color: #555; text-decoration: underline; font-size: 14px;">Back to Main</a>
    </div>
    {% endif %}
</div>

<div class="overlay" id="overlay"></div>
<div class="modal" id="modal">
    <button class="close-btn" onclick="closeModal()">Ã—</button>
    <h2>Load Timetable</h2>
    <form id="timetableForm">
        <div>
            <label for="new_url">URL:</label>
            <input type="text" id="new_url" name="new_url" placeholder="Ex) https://everytime.kr/@BXKPWWB2AgrzOkjujSaa" required>
        </div>
        <br>
        <button type="button" onclick="submitTimetableUrl()">Save Timetable</button>
    </form>
</div>

<script>
    function openModal() {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
        document.getElementById('new_url').value = '';
    }

    let subjectCount = 0;

    document.addEventListener('DOMContentLoaded', function() {
        if (document.querySelectorAll('#subjects .subject-item').length === 0) {
            addSubject(null); // ì´ˆê¸° ì•„ì´í…œ ì¶”ê°€ (ê¸°ì¤€ì  ì—†ì´)
        }
    });

    function updateSliderValue(spanId, value) {
        const spanElement = document.getElementById(spanId);
        if (spanElement) {
            spanElement.innerText = value;
        }
    }

    function addSubject(afterElement, subjectName = '') {
        subjectCount++;
        const subjectItemId = `subjectItem${subjectCount}`;
        const nameId = `name${subjectCount}`;
        const majorId = `major${subjectCount}`;
        const weightId = `weight${subjectCount}`;
        const sliderValueId = `sliderValue${subjectCount}`;

        const div = document.createElement('div');
        div.classList.add('subject-item');
        div.id = subjectItemId;

        div.innerHTML = `
            <div class="subject-inputs">
                <label for="${nameId}">Subject:</label>
                <input type="text" id="${nameId}" name="name" value="${subjectName}" required>

                <label for="${majorId}">Major Course:</label>
                <input type="checkbox" id="${majorId}" name="major" class="toggle-btn">

                <label for="${weightId}">Importance Level:</label>
                <input type="range" id="${weightId}" name="weight" min="0" max="100" step="1" value="50"
                       oninput="updateSliderValue('${sliderValueId}', this.value)">
                <span id="${sliderValueId}">50</span>
            </div>
            <div class="subject-actions-container">
                <div class="action-left">
                    <button type="button" class="action-btn plus-style-button remove-btn" onclick="removeSubject('${subjectItemId}')">ğŸ—‘ï¸ Delete</button>
                </div>
                <div class="action-right">
                    <button type="button" class="action-btn plus-style-button add-below-btn" onclick="addSubject(this.closest('.subject-item'))">+ Add Subject</button>
                </div>
            </div>
        `;

        const subjectsDiv = document.getElementById('subjects');
        if (afterElement) {
            // afterElement ë‹¤ìŒ í˜•ì œ ìœ„ì¹˜ì— div ì‚½ì…
            // afterElement.nextSiblingì´ nullì´ë©´ ë§¨ ë’¤ì— ì¶”ê°€ë¨ (appendChildì™€ ìœ ì‚¬ íš¨ê³¼)
            afterElement.parentNode.insertBefore(div, afterElement.nextSibling);
        } else {
            subjectsDiv.appendChild(div); // ë§¨ ë’¤ì— ì¶”ê°€ (ì´ˆê¸° í˜¸ì¶œ ë˜ëŠ” afterElementê°€ ì—†ì„ ë•Œ)
        }
    }

    function removeSubject(subjectItemId) {
        const subjectItemToRemove = document.getElementById(subjectItemId);
        const subjectsDiv = document.getElementById('subjects');
        if (subjectItemToRemove) {
            if (subjectsDiv.getElementsByClassName('subject-item').length > 1) {
                subjectItemToRemove.remove();
            } else {
                alert('At least one subject must remain.');
            }
        }
    }

    function submitTimetableUrl() {
        const timetableUrl = document.getElementById('new_url').value;
        if (!timetableUrl) {
            alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        const formData = new FormData();
        formData.append('new_url', timetableUrl);

        fetch('/process_timetable', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    // ì—ëŸ¬ ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹± ì‹œë„
                    return response.json()
                        .then(errData => {
                            // errData.errorê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì¼ë°˜ ë©”ì‹œì§€
                            throw new Error(errData.error || `ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: ${response.status}`);
                        })
                        .catch(() => {
                            // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ (ì‘ë‹µì´ JSONì´ ì•„ë‹ ê²½ìš°)
                            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜. ìƒíƒœ ì½”ë“œ: ${response.status}`);
                        });
                }
                return response.json(); // ì„±ê³µ ì‹œ JSON íŒŒì‹±
            })
            .then(data => {
                console.log('ì„œë²„ ì‘ë‹µ:', data);
                if (data.error) {
                    alert('ì‹œê°„í‘œ ë¡œë”© ì˜¤ë¥˜: ' + data.error);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ì¡´ ëª©ë¡ì„ ë¹„ìš°ì§€ ì•Šê³ , ìƒˆë¡œìš´ í•­ëª©ì„ ì¶”ê°€í•˜ì§€ë„ ì•ŠìŠµë‹ˆë‹¤.
                    // í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì„œ populateSubjectsFromTimetable([]) í˜¸ì¶œì„ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                } else if (data.timetable_slots && Array.isArray(data.timetable_slots)) {
                    populateSubjectsFromTimetable(data.timetable_slots);
                    closeModal();
                    // ì„±ê³µ ë©”ì‹œì§€ëŠ” populate í›„, ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  í‘œì‹œí•˜ëŠ” ê²ƒì´ ë” ì¢‹ì„ ìˆ˜ ìˆìŒ
                    if (data.timetable_slots.length > 0) {
                        alert('ì‹œê°„í‘œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    } else if (data.message) { // ì„œë²„ì—ì„œ ë¹ˆ ì‹œê°„í‘œì— ëŒ€í•œ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆì„ ê²½ìš°
                        alert(data.message);
                    } else {
                        alert('ì‹œê°„í‘œëŠ” ë¶ˆëŸ¬ì™”ìœ¼ë‚˜, í¬í•¨ëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } else {
                    // data.timetable_slotsê°€ ì—†ê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš°
                    alert('ì‹œê°„í‘œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆê±°ë‚˜, í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    // ì´ ê²½ìš°ì—ë„ ê¸°ì¡´ ëª©ë¡ì„ ìœ ì§€í•˜ê±°ë‚˜, populateSubjectsFromTimetable([])ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    // í˜„ì¬ëŠ” ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•Šì•„ ê¸°ì¡´ ëª©ë¡ì´ ìœ ì§€ë©ë‹ˆë‹¤.
                }
            })
            .catch(error => {
                console.error('ì‹œê°„í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ì‹œê°„í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
    }

    function populateSubjectsFromTimetable(slots) {
        const subjectsDiv = document.getElementById('subjects');
        subjectsDiv.innerHTML = ''; // ê¸°ì¡´ ê³¼ëª© ëª¨ë‘ ì œê±°
        subjectCount = 0;           // ì¹´ìš´í„° ì´ˆê¸°í™”

        const uniqueSubjects = new Set();
        if (Array.isArray(slots)) { // slotsê°€ ë°°ì—´ì¸ì§€ í•œ ë²ˆ ë” í™•ì¸
            slots.forEach(slot => {
                // slot[0]ì´ 'ìˆ˜ì—…'ì´ê³ , slot[1] (ê³¼ëª©ëª…)ì´ ìœ íš¨í•œ ë¬¸ìì—´ì¼ ë•Œ ì¶”ê°€
                if (slot && slot.length > 1 && slot[0] === 'ìˆ˜ì—…' && typeof slot[1] === 'string' && slot[1].trim() !== "N/A" && slot[1].trim() !== "") {
                    uniqueSubjects.add(slot[1].trim());
                }
            });
        }

        uniqueSubjects.forEach(subjectName => {
            addSubject(null, subjectName); // ê° ìœ ë‹ˆí¬í•œ ê³¼ëª©ì„ ë¦¬ìŠ¤íŠ¸ ëì— ì¶”ê°€
        });

        // ëª¨ë“  ê³¼ëª©ì„ ì¶”ê°€í•œ í›„, subjectsDivì— ì•„ë¬´ëŸ° .subject-itemì´ ì—†ë‹¤ë©´,
        // (ì¦‰, uniqueSubjectsê°€ ë¹„ì–´ ìˆì—ˆê±°ë‚˜, slotsê°€ ë¹„ì •ìƒì ì´ì–´ì„œ ì•„ë¬´ê²ƒë„ ì¶”ê°€ë˜ì§€ ì•Šì•˜ë‹¤ë©´)
        // ê¸°ë³¸ ë¹ˆ ê³¼ëª© ì…ë ¥ ì¹¸ í•˜ë‚˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        if (subjectsDiv.children.length === 0) {
            addSubject(null);
        }
    }
</script>

</body>
</html>