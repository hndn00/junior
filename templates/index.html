<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Study Planner</title>
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
<div class="container">
    {% if session.username %}
        <div class="top-right-menu">
            <a href="/logout" class="logout-btn">Log Out</a>
        </div>
    {% endif %}

    <h1>Study Planner</h1>
    <form action="/plan" method="post">
        <div>
            <label for="total_hours">Total Study Time (hours):</label>
            <input type="number" id="total_hours" name="total_hours" step="0.1" required>
        </div>
        <button type="button" class="add-timetable-btn add-new-timetable-btn" onclick="openModal()">Load Timetable</button>
        <hr>
        <div id="subjects">
            <div class="subject-item">
                <label for="name1">Subject:</label>
                <input type="text" id="name1" name="name" required>

                <label for="major1">Major Course:</label>
                <input type="checkbox" id="major1" name="major" class="toggle-btn">

                <label for="weight1">Importance Level:</label> <input type="range" id="weight1" name="weight" min="0" max="100" step="1" value="50"
                                                                      oninput="updateSliderValue('sliderValue1', this.value)">
                <span id="sliderValue1">50</span>
            </div>
        </div>
        <button type="button" onclick="addSubject()">Add Subject</button><br><br>
        <button type="submit">Calculate Study Time</button>
    </form>

    {% if not session.username %}
        <div style="text-align: center; margin-top: 20px;">
            <a href="/" style="color: #555; text-decoration: underline; font-size: 14px;">Back to Main</a>
        </div>
    {% endif %}
</div>

<div class="overlay" id="overlay"></div>
<div class="modal" id="modal">
    <button class="close-btn" onclick="closeModal()">×</button>
    <h2>Load Timetable</h2>
    <form id="timetableForm">
        <div>
            <label for="new_url">URL:</label>
            <input type="text" id="new_url" name="new_url" placeholder="Ex) https://everytime.kr/@BXKPWWB2AgrzOkjujSaa" required>
        </div>
        <br>
        <button type="button" onclick="submitTimetableUrl()">Save Timetable</button>
    </form>
</div>

<script>
    // 모달 창 열기
    function openModal() {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    }

    // 모달 창 닫기
    function closeModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
        document.getElementById('new_url').value = ''; // 모달 닫을 때 URL 입력 필드 초기화
    }

    let subjectCount = 1; // 현재 페이지의 과목 입력 필드 개수를 추적

    // 페이지 로드 시 #subjects 내 .subject-item 개수로 subjectCount 초기화
    document.addEventListener('DOMContentLoaded', function() {
        const initialSubjects = document.querySelectorAll('#subjects .subject-item');
        subjectCount = initialSubjects.length > 0 ? initialSubjects.length : 0;
        if (subjectCount === 0) { // 만약 초기에 아무 과목도 없다면 하나 추가 (선택적)
            addSubject();
        }
    });


    // 슬라이더 값 업데이트 함수 (0~100 사이 값 표시)
    function updateSliderValue(spanId, value) {
        const spanElement = document.getElementById(spanId);
        if (spanElement) {
            spanElement.innerText = value;
        }
    }

    // 추가 버튼을 눌렀을 때 빈 과목 입력 필드 추가
    function addSubject() {
        subjectCount++;
        const div = document.createElement('div');
        div.classList.add('subject-item');
        div.innerHTML = `
            <label for="name${subjectCount}">Subject:</label>
            <input type="text" id="name${subjectCount}" name="name" required>

            <label for="major${subjectCount}">Major Course:</label>
            <input type="checkbox" id="major${subjectCount}" name="major" class="toggle-btn">

            <label for="weight${subjectCount}">Importance Level:</label>
            <input type="range" id="weight${subjectCount}" name="weight" min="0" max="100" step="1" value="50"
                   oninput="updateSliderValue('sliderValue${subjectCount}', this.value)">
            <span id="sliderValue${subjectCount}">50</span>
        `;
        document.getElementById('subjects').appendChild(div);
    }

    // 에브리타임 URL 제출 함수
    function submitTimetableUrl() {
        const timetableUrl = document.getElementById('new_url').value;
        if (!timetableUrl) {
            alert('URL을 입력해주세요.');
            return;
        }

        // FormData를 사용하여 POST 요청 본문 구성 (Flask에서 request.form으로 받기 위함)
        const formData = new FormData();
        formData.append('new_url', timetableUrl);

        fetch('/process_timetable', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                // 응답이 정상적이지 않을 경우 (예: 4xx, 5xx 오류) JSON 파싱 전 오류 처리
                if (!response.ok) {
                    return response.json().then(errData => {
                        // 서버에서 보낸 error 메시지가 있다면 사용, 없다면 일반 메시지
                        throw new Error(errData.error || `서버 오류가 발생했습니다. 상태 코드: ${response.status}`);
                    });
                }
                return response.json(); // Flask가 딕셔너리를 JSON으로 자동 변환한 것을 파싱
            })
            .then(data => {
                console.log('서버 응답:', data); // 디버깅용: 서버 응답 전체 확인
                if (data.error) {
                    alert('시간표 로딩 오류: ' + data.error);
                } else if (data.timetable_slots && Array.isArray(data.timetable_slots)) {
                    populateSubjectsFromTimetable(data.timetable_slots);
                    closeModal();
                    alert('시간표를 성공적으로 불러왔습니다!');
                } else {
                    alert('시간표 데이터를 불러오는데 실패했거나, 형식이 올바르지 않습니다.');
                    // 데이터는 있지만 슬롯이 없는 경우 (예: 빈 시간표)
                    if (data.timetable_slots && data.timetable_slots.length === 0 && data.message) {
                        alert(data.message); // 서버에서 보낸 메시지 표시
                    }
                    populateSubjectsFromTimetable([]); // 빈 배열로 호출하여 과목 필드 초기화 또는 기본 필드 추가
                }
            })
            .catch(error => {
                console.error('시간표 처리 중 오류 발생:', error);
                alert('시간표 처리 중 오류가 발생했습니다: ' + error.message);
            });
    }

    // 불러온 시간표 데이터로 과목 입력 필드 채우기
    function populateSubjectsFromTimetable(slots) {
        const subjectsDiv = document.getElementById('subjects');
        subjectsDiv.innerHTML = ''; // 기존 과목 입력 필드 모두 제거
        subjectCount = 0; // 과목 카운터 초기화

        const uniqueSubjects = new Set();
        slots.forEach(slot => {
            // slot[0]은 type ("수업" 또는 "공강")
            // slot[1]은 name (과목명 또는 공강의 경우 빈 문자열)
            if (slot[0] === '수업' && slot[1] && slot[1].trim() !== "N/A" && slot[1].trim() !== "") {
                uniqueSubjects.add(slot[1].trim());
            }
        });

        if (uniqueSubjects.size === 0) {
            // alert("시간표에 유효한 수업 정보가 없습니다. 기본 입력 필드를 추가합니다.");
            addSubject(); // 불러온 수업이 없으면 기본 빈 과목 필드 1개 추가
            return;
        }

        uniqueSubjects.forEach(subjectName => {
            subjectCount++;
            const div = document.createElement('div');
            div.classList.add('subject-item');
            // 불러온 과목명으로 input 필드의 value를 설정
            // Major Course 체크박스와 Importance Level 슬라이더는 기본값으로 설정
            div.innerHTML = `
                <label for="name${subjectCount}">Subject:</label>
                <input type="text" id="name${subjectCount}" name="name" value="${subjectName}" required>

                <label for="major${subjectCount}">Major Course:</label>
                <input type="checkbox" id="major${subjectCount}" name="major" class="toggle-btn">

                <label for="weight${subjectCount}">Importance Level:</label>
                <input type="range" id="weight${subjectCount}" name="weight" min="0" max="100" step="1" value="50"
                       oninput="updateSliderValue('sliderValue${subjectCount}', this.value)">
                <span id="sliderValue${subjectCount}">50</span>
            `;
            subjectsDiv.appendChild(div);
        });
    }
</script>
</body>
</html>