<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Study Planner</title>
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
<div class="container">
    {% if session.username %}
    <div class="top-right-menu">
        <a href="/logout" class="logout-btn">Log Out</a>
    </div>
    {% endif %}

    <h1>Study Planner</h1>
    <form action="/plan" method="post">
        <div>
            <label for="total_hours">Total Study Time (hours):</label>
            <input type="number" id="total_hours" name="total_hours" step="0.1" required>
        </div>
        <button type="button" class="add-timetable-btn add-new-timetable-btn" onclick="openModal()">Load Timetable</button>
        <hr>
        <div id="subjects">
            <div class="subject-item" id="subjectItem1">
                <div class="subject-inputs">
                    <label for="name1">Subject:</label>
                    <input type="text" id="name1" name="name" required>

                    <label for="major1">Major Course:</label>
                    <input type="checkbox" id="major1" name="major" class="toggle-btn">

                    <label for="weight1">Importance Level:</label>
                    <input type="range" id="weight1" name="weight" min="0" max="100" step="1" value="50"
                           oninput="updateSliderValue('sliderValue1', this.value)">
                    <span id="sliderValue1">50</span>
                </div>
                <button type="button" class="remove-subject-btn" onclick="removeSubject('subjectItem1')">Remove</button>
            </div>
        </div>
        <button type="button" onclick="addSubject()">Add Subject</button><br><br>
        <button type="submit">Calculate Study Time</button>
    </form>

    {% if not session.username %}
    <div style="text-align: center; margin-top: 20px;">
        <a href="/" style="color: #555; text-decoration: underline; font-size: 14px;">Back to Main</a>
    </div>
    {% endif %}
</div>

<div class="overlay" id="overlay"></div>
<div class="modal" id="modal">
    <button class="close-btn" onclick="closeModal()">×</button>
    <h2>Load Timetable</h2>
    <form id="timetableForm">
        <div>
            <label for="new_url">URL:</label>
            <input type="text" id="new_url" name="new_url" placeholder="Ex) https://everytime.kr/@BXKPWWB2AgrzOkjujSaa" required>
        </div>
        <br>
        <button type="button" onclick="submitTimetableUrl()">Save Timetable</button>
    </form>
</div>

<script>
    // 모달 창 열기
    function openModal() {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal').style.display = 'block';
    }

    // 모달 창 닫기
    function closeModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
        document.getElementById('new_url').value = '';
    }

    let subjectCount = 0; // 고유 ID 생성을 위한 카운터 (실제 과목 수와는 다를 수 있음)

    document.addEventListener('DOMContentLoaded', function() {
        const initialSubjects = document.querySelectorAll('#subjects .subject-item');
        if (initialSubjects.length > 0) {
            // 가장 큰 ID 번호를 찾아 subjectCount 설정 (더 견고한 방법)
            let maxIdNum = 0;
            initialSubjects.forEach(item => {
                const idNum = parseInt(item.id.replace('subjectItem', ''));
                if (idNum > maxIdNum) {
                    maxIdNum = idNum;
                }
            });
            subjectCount = maxIdNum;
        } else {
            addSubject(); // 초기에 아무 과목도 없으면 하나 추가
        }
    });


    function updateSliderValue(spanId, value) {
        const spanElement = document.getElementById(spanId);
        if (spanElement) {
            spanElement.innerText = value;
        }
    }

    function addSubject(subjectName = '') { // 과목명을 인자로 받을 수 있도록 수정
        subjectCount++;
        const subjectItemId = `subjectItem${subjectCount}`;
        const nameId = `name${subjectCount}`;
        const majorId = `major${subjectCount}`;
        const weightId = `weight${subjectCount}`;
        const sliderValueId = `sliderValue${subjectCount}`;

        const div = document.createElement('div');
        div.classList.add('subject-item');
        div.id = subjectItemId; // 각 subject-item div에 고유 ID 부여

        div.innerHTML = `
            <div class="subject-inputs">
                <label for="${nameId}">Subject:</label>
                <input type="text" id="${nameId}" name="name" value="${subjectName}" required>

                <label for="${majorId}">Major Course:</label>
                <input type="checkbox" id="${majorId}" name="major" class="toggle-btn">

                <label for="${weightId}">Importance Level:</label>
                <input type="range" id="${weightId}" name="weight" min="0" max="100" step="1" value="50"
                       oninput="updateSliderValue('${sliderValueId}', this.value)">
                <span id="${sliderValueId}">50</span>
            </div>
            <button type="button" class="remove-subject-btn" onclick="removeSubject('${subjectItemId}')">Remove</button>
        `;
        document.getElementById('subjects').appendChild(div);
    }

    // 과목 입력 필드 제거 함수
    function removeSubject(subjectItemId) {
        const subjectItemToRemove = document.getElementById(subjectItemId);
        if (subjectItemToRemove) {
            // 최소 1개의 과목은 남겨두도록 처리 (선택적)
            const subjectsDiv = document.getElementById('subjects');
            if (subjectsDiv.getElementsByClassName('subject-item').length > 1) {
                subjectItemToRemove.remove();
            } else {
                alert('At least one subject must remain.');
            }
        }
    }


    function submitTimetableUrl() {
        const timetableUrl = document.getElementById('new_url').value;
        if (!timetableUrl) {
            alert('URL을 입력해주세요.');
            return;
        }

        const formData = new FormData();
        formData.append('new_url', timetableUrl);

        fetch('/process_timetable', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(errData.error || `서버 오류가 발생했습니다. 상태 코드: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('서버 응답:', data);
                if (data.error) {
                    alert('시간표 로딩 오류: ' + data.error);
                } else if (data.timetable_slots && Array.isArray(data.timetable_slots)) {
                    populateSubjectsFromTimetable(data.timetable_slots);
                    closeModal();
                    alert('시간표를 성공적으로 불러왔습니다!');
                } else {
                    alert('시간표 데이터를 불러오는데 실패했거나, 형식이 올바르지 않습니다.');
                    if (data.timetable_slots && data.timetable_slots.length === 0 && data.message) {
                        alert(data.message);
                    }
                    populateSubjectsFromTimetable([]);
                }
            })
            .catch(error => {
                console.error('시간표 처리 중 오류 발생:', error);
                alert('시간표 처리 중 오류가 발생했습니다: ' + error.message);
            });
    }

    function populateSubjectsFromTimetable(slots) {
        const subjectsDiv = document.getElementById('subjects');
        subjectsDiv.innerHTML = ''; // 기존 과목 입력 필드 모두 제거
        // subjectCount는 addSubject 내부에서 증가하므로 여기서 초기화할 필요 없음 (단, ID 충돌 방지 위해 addSubject에서 사용하는 subjectCount는 계속 증가하는 값이어야 함)
        // 또는 여기서 subjectCount = 0; 으로 초기화하고 addSubject가 이 값을 사용하도록 수정

        const uniqueSubjects = new Set();
        slots.forEach(slot => {
            if (slot[0] === '수업' && slot[1] && slot[1].trim() !== "N/A" && slot[1].trim() !== "") {
                uniqueSubjects.add(slot[1].trim());
            }
        });

        if (uniqueSubjects.size === 0) {
            addSubject(); // 불러온 수업이 없으면 기본 빈 과목 필드 1개 추가
            return;
        }

        uniqueSubjects.forEach(subjectName => {
            addSubject(subjectName); // 수정된 addSubject 함수 호출
        });
    }
</script>
</body>
</html>